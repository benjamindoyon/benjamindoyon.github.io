<!DOCTYPE html>
<html>

<style>
#container {
	margin: 0px auto;
	width: 800px;
	height: 800px;
	border: 10px #333 solid;
	position: relative;
}
#controls {
	margin: 0px auto;
	width: 700px;
	height: 150px;
	position: relative;
	background-color: #CCC;
	border: 5px #CCC solid;
}
#mainVideo {
	width: 800px;
	height: 800px;
	position: absolute;
	visibility: hidden;
}
#secondaryVideo {
	width: 200px;
	height: 200px;
	position: absolute;
	bottom: 0;
	right: 0;
	visibility: hidden;
}
#canvas {
	width: 800px;
	height: 800px;
	background-color: black;
	position: absolute;
}
#playbackVideo {
	width: 500px;
	height: 375px;
	position: absolute;
	visibility: hidden;
}
#camera {
	width: 150px;
	height: 150px;
	position: absolute;
	left: 0;
	top: 0;
}
#cameraVideo {
	width: 150px;
	height: 150px;
	background-color: #444;
	position: absolute;
	left: 50%;
	top: 50%;
	transform: translate(-50%,-50%);
}
#configs {
	width: 150px;
	height: 150px;
	position: absolute;
	left: 150px;
	top: 0;
}
#buttonConf1 {
	width: 60px;
	height: 50px;
	position: absolute;
	left: 10px;
	top: 10px;
	border-radius: 5px;
	background-color: #DDD;
	font-size: 20px;
}
#buttonConf2 {
	width: 60px;
	height: 50px;
	position: absolute;
	right: 10px;
	top: 10px;
	border-radius: 5px;
	background-color: #DDD;
	font-size: 20px;
}
#buttonConf3 {
	width: 60px;
	height: 50px;
	position: absolute;
	left: 10px;
	bottom: 30px;
	border-radius: 5px;
	background-color: #DDD;
	font-size: 20px;
}
#buttonConf4 {
	width: 60px;
	height: 50px;
	position: absolute;
	right: 10px;
	bottom: 30px;
	border-radius: 5px;
	background-color: #DDD;
	font-size: 20px;
}
#confinstruction {
	width: 150px;
	height: 20px;
	position: absolute;
	left: 0px;
	bottom: 5px;
	font-size: 15px;
	font-family: sans-serif;
	text-align: center;
}
#rec {
	width: 150px;
	height: 150px;
	position: absolute;
	left: 300px;
	top: 0;
}
#light {
	width: 15px;
	height: 15px;
	position: absolute;
	left: 65px;
	top: 5px;
	border-radius: 15px;
	background-color: #000;
}
#buttonRecord {
	width: 80px;
	height: 40px;
	position: absolute;
	left: 10px;
	bottom: 85px;
	border-radius: 5px;
	background-color: #DDD;
	font-size: 15px;
}
#buttonPause {
	width: 40px;
	height: 40px;
	position: absolute;
	right: 10px;
	bottom: 85px;
	border-radius: 5px;
	background-color: #DDD;
}
#buttonPlayback {
	width: 130px;
	height: 30px;
	position: absolute;
	left: 10px;
	bottom: 35px;
	border-radius: 5px;
	background-color: #DDD;
	font-size: 15px;
}
#buttonStitch {
	width: 60px;
	height: 30px;
	position: absolute;
	left: 10px;
	bottom: 0px;
	border-radius: 5px;
	background-color: #DDD;
	font-size: 15px;
}
#buttonSave {
	width: 60px;
	height: 30px;
	position: absolute;
	left: 80px;
	bottom: 0px;
	border-radius: 5px;
	background-color: #AFF;
	font-size: 15px;
}
#comp {
	width: 150px;
	height: 150px;
	position: absolute;
	left: 450px;
	top: 0;
}
#buttonChooseComponent {
	width: 130px;
	height: 130px;
	position: absolute;
	left: 10px;
	top: 10px;
	border-radius: 5px;
	background-color: #DDD;
	font-size: 15px;
}
#buttonStopComponent {
	width: 60px;
	height: 60px;
	position: absolute;
	left: 45px;
	bottom: 45px;
	border-radius: 5px;
	background-color: #DDD;
	font-size: 15px;
	visibility: hidden;
}
#componentVideo {
	width: 150px;
	height: 150px;
	position: absolute;
	left: 50%;
	top: 50%;
	transform: translate(-50%,-50%);
  	background-color: #444;
	visibility: hidden;
}
#intro {
	width: 100px;
	height: 150px;
	position: absolute;
	left: 600px;
	top: 0;
	font-family: sans-serif;
	font-size: 15px;
}
.buttonbg {
	background-color: #DDD;
}

</style>

<div id="container">
	<video id="mainVideo" autoplay="true"></video>
    <video id="secondaryVideo" autoplay="true"></video>
    <canvas id="canvas"></canvas>
    <video id="playbackVideo" controls></video>
</div>

<div id="controls">
	<div id = "camera">
		<video id="cameraVideo" autoplay="true"></video>
	</div>
	<div id="configs">
	  	<input id="buttonConf1" type="button" value="1" />
		<input id="buttonConf2" type="button" value="2" />
		<input id="buttonConf3" type="button" value="3" />
		<input id="buttonConf4" type="button" value="4" />
		<div id="confinstruction">
			select configuration
		</div>
	</div>
	<div id="rec">
	    <div id="light"></div>
		<input id="buttonRecord" type="button" value="rec" />
		<input id="buttonPause" type="button" value="||" />
		<input id="buttonPlayback" type="button" value="playback" />
		<input id="buttonSave" type="button" value="save" />
		<input id="buttonStitch" type="button" value="stitch" />
		<a id="buttonDownload" style="visibility: hidden"> download </a>
	</div>
	<div id="comp">
		<input id="buttonChooseComponent" type="button" value="select&#10; shared window" />
	    <video id="componentVideo" autoplay="true"></video>
		<input id="buttonStopComponent" type="button" value="stop" />
	</div>
	<div id="intro">
		<div style="width: 5px; height: 5px;" ></div>
		<input id="checkboxWatermark" type="checkbox"  />
		<label> watermark </label>
		<br>
		<input id="checkboxIntro" type="checkbox" />
		<label> intro </label>
		<br>
		<input id="checkboxOutro" type="checkbox" />
		<label> outro </label>
		<br>
		<input id="checkboxTitle" type="checkbox" />
		<label id="labelTitle"> title </label>
		<input id="buttonTitle" type="button" class="buttonbg" value="set"/>
		<br>
		<textarea id="textTitle" rows="2" cols="20" style="z-index: 1; position: absolute; left:10px; top:85px; font-family: sans-serif; font-size: 12px; visibility: hidden">Title</textarea>
	</div>
</div>


</html>

<script>

var mainVideo = document.getElementById("mainVideo");
var secondaryVideo = document.getElementById("secondaryVideo");
var playbackVideo = document.getElementById("playbackVideo");
var canvas = document.getElementById("canvas");
var imageCanvas = document.createElement("canvas");
var cameraVideo = document.getElementById("cameraVideo");
var componentVideo = document.getElementById("componentVideo");
var controls = document.getElementById("controls");
var buttonConf1 = document.getElementById('buttonConf1');
var buttonConf2 = document.getElementById('buttonConf2');
var buttonConf3 = document.getElementById('buttonConf3');
var buttonConf4 = document.getElementById('buttonConf4');
var buttonRecord = document.getElementById('buttonRecord');
var buttonPause = document.getElementById('buttonPause');
var buttonPlayback = document.getElementById('buttonPlayback');
var buttonDownload = document.getElementById('buttonDownload');
var buttonStitch = document.getElementById('buttonStitch');
var buttonSave = document.getElementById('buttonSave');
var buttonChooseComponent = document.getElementById('buttonChooseComponent');
var buttonStopComponent = document.getElementById('buttonStopComponent');
var comp = document.getElementById('comp');
var textTitle = document.getElementById('textTitle');
var checkboxWatermark = document.getElementById('checkboxWatermark');
var checkboxIntro = document.getElementById('checkboxIntro');
var checkboxOutro = document.getElementById('checkboxOutro');
var checkboxTitle = document.getElementById('checkboxTitle');
var labelTitle = document.getElementById('labelTitle');
var buttonTitle = document.getElementById('buttonTitle');

var watermarkImage = document.createElement("img");
watermarkImage.src = "kings/Watermark.png";
var introVideo = document.createElement("video");
introVideo.src = "kings/Intro.mp4";
introVideo.type = "video/mp4";
var outroVideo = document.createElement("video");
outroVideo.src = "kings/Outro.mp4";
outroVideo.type = "video/mp4";

var pixels = 1000000;
var framePerSecond = 20;
var fixedRatioMode = true;

var theTitleLines = [];

cameraVideo.muted = true;
componentVideo.muted = true;
mainVideo.muted = true;
secondaryVideo.muted = true;

const controlsVideoMaxWidth = 150;
const controlsVideoMaxHeight = 150;
const totalBorder = 60;

var fixedRatio=1;
var mainRatio=1;
var mainWidthFactor=1;
var mainHeightFactor=1;
var playbackRatio = 1;
var secondaryRatio=1;
var secondaryWidthFactor=1/4;
var secondaryHeightFactor=1/4;
var factor = 1/4;
var factorList = [1/4,1/4,1/2,1/4,1/4]

var selectedState = 1;
var currentState = 0;

var recording = 0;
var paused = 0;
var playingback = 0;
var fadingDown = 0;
var fadingUp = 0;
var playingIntro = 0;
var playingOutro = 0;
var playingTitle = 0;
var comingBack = 0;
var stitching = 0;
var alpha=1;

var changeMain = 1;

var mediaRecorder;
var stopImages = [];
var numberStopImages = 0;

function tocss(x) {
	return x.toString() + "px";
}

function resize(whratio, wmax, hmax) {
	if (whratio < wmax/hmax) {
		var hnew = hmax;
		var wnew = hmax*whratio;
	} else {
		var hnew = wmax/whratio;
		var wnew = wmax;
	}
	return [wnew, hnew];
}

function resizecss(whratio, wmax, hmax) {
	const [wnew, hnew] = resize(whratio, wmax, hmax);
	return [tocss(wnew), tocss(hnew)];
}

function sizeAll() {
	var w,h;
	factor = factorList[currentState];
	if (fixedRatioMode) {
		[w,h] = resize(fixedRatio,window.innerWidth-totalBorder,window.innerHeight-controlsVideoMaxHeight-totalBorder);
		let [sw,sh] = resize(mainRatio,w,h);
		[mainVideo.style.width, mainVideo.style.height] = [tocss(sw),tocss(sh)];
		[mainWidthFactor, mainHeightFactor] = [sw/w, sh/h];
	} else {
		if (!playingback) [w,h] = resize(mainRatio,window.innerWidth-totalBorder,window.innerHeight-controlsVideoMaxHeight-totalBorder);
		else [w,h] = resize(playbackRatio,window.innerWidth-totalBorder,window.innerHeight-controlsVideoMaxHeight-totalBorder);
		[mainVideo.style.width, mainVideo.style.height] = [tocss(w), tocss(h)];
		[mainWidthFactor, mainHeightFactor] = [1,1];
	}
	[container.style.width, container.style.height] = [tocss(w), tocss(h)];
	[playbackVideo.style.width, playbackVideo.style.height] = [container.style.width, container.style.height];
	[canvas.style.width, canvas.style.height] = [container.style.width, container.style.height];
	let [sw,sh] = resize(secondaryRatio,w*factor,h*factor);
	[secondaryVideo.style.width, secondaryVideo.style.height] = [tocss(sw), tocss(sh)];
	[secondaryWidthFactor, secondaryHeightFactor] = [sw/w, sh/h];
}

function setMain(v) {
	if (!changeMain) return;
	mainVideo.srcObject = v.srcObject;
    if (v.srcObject) mainRatio = (v.videoWidth-v.clipLeft-v.clipRight)/(v.videoHeight-v.clipUp-v.clipDown);
    else mainRatio = 1;
    mainVideo.clipLeft = v.clipLeft;
    mainVideo.clipUp = v.clipUp;
   	mainVideo.clipWidth = v.videoWidth -v.clipLeft-v.clipRight;
    mainVideo.clipHeight = v.videoHeight -v.clipUp-v.clipDown;
 }

function setSecondary(v) {
	if (v && v.srcObject) {
		secondaryVideo.srcObject = v.srcObject;
    	secondaryRatio = (v.videoWidth-v.clipLeft-v.clipRight)/(v.videoHeight-v.clipUp-v.clipDown);
    	secondaryVideo.clipLeft = v.clipLeft;
    	secondaryVideo.clipUp = v.clipUp;
    	secondaryVideo.clipWidth = v.videoWidth -v.clipLeft-v.clipRight;
    	secondaryVideo.clipHeight = v.videoHeight -v.clipUp-v.clipDown;
 	} else {
		secondaryVideo.srcObject = null;
    	secondaryRatio = 1;
	}
}

function setButtons() {
	buttonConf1.style.backgroundColor = "#DDD";
	buttonConf2.style.backgroundColor = "#DDD";
	buttonConf3.style.backgroundColor = "#DDD";
	buttonConf4.style.backgroundColor = "#DDD";
	if (selectedState == 1) buttonConf1.style.backgroundColor = "#BBF";
	if (selectedState == 2) buttonConf2.style.backgroundColor = "#BBF";
	if (selectedState == 3) buttonConf3.style.backgroundColor = "#BBF";
	if (selectedState == 4) buttonConf4.style.backgroundColor = "#BBF";
}

function setState() {
	playingTitle = 0;
	if (selectedState == 1) {
		setMain(cameraVideo);
		setSecondary(null);
		currentState = 1;
	} else if (selectedState == 2) {
		setMain(cameraVideo);
		setSecondary(componentVideo);
		if (componentVideo.srcObject) currentState = 2;
		else currentState = 1;
	} else if (selectedState == 3) {
    	if (componentVideo.srcObject) {
    		setMain(componentVideo);
    		setSecondary(cameraVideo);
			currentState = 3;
    	} else {
			setMain(cameraVideo);
			setSecondary(null);
			currentState = 1;
    	}
	} else if (selectedState == 4) {
    	if (componentVideo.srcObject) {
    		setMain(componentVideo);
			currentState = 4;
    	} else {
    		setMain(cameraVideo);
			currentState = 1;
    	}
    	setSecondary(null);
	}
	sizeAll();
}

function changeState(state) {
	if (playingTitle || playingIntro || playingOutro || fadingDown || fadingUp || playingback) return;
	if (!cameraVideo.srcObject) selectedState = 4;
	if (state && cameraVideo.srcObject) selectedState = state;
	if (!componentVideo.srcObject) virtualState = 1;
	else virtualState = selectedState;
	setButtons();
	if (currentState==1 && virtualState==2) changeMain=0;
	else if (currentState==2 && virtualState==1) changeMain=0;
	else if (currentState==3 && virtualState==4) changeMain=0;
	else if (currentState==4 && virtualState==3) changeMain=0;
	else changeMain = 1;
	if (currentState != virtualState) fadingDown = 1;
}

var lightInterval;
var recordedChunks = [];
var newChunkLength = 0;
var lastChunkLength = 0;
var recordedBlobList = [];
var countVideoChunk;

function stitchVideo() {
	var canvasStream = new MediaStream(canvas.captureStream(framePerSecond));
	var options = { mimeType: "video/webm" };
	recordedChunks = [];
	mediaRecorder = new MediaRecorder(canvasStream,options);
	mediaRecorder.ondataavailable = event => recordedChunks.push(event.data);
	mediaRecorder.onstop = event => {
		recordedBlobList = [];
		recordedBlobList.push(new Blob(recordedChunks, {type: "video/webm"}));
		if (playbackVideo.src) URL.revokeObjectURL(playbackVideo.src);
		playbackVideo.src = URL.createObjectURL(recordedBlobList[0]);
		countVideoChunk = 0;
		playbackVideo.onplay = null;
	}
	if (playbackVideo.src) URL.revokeObjectURL(playbackVideo.src);
	playbackVideo.src = URL.createObjectURL(recordedBlobList[0]);
	countVideoChunk = 0;
	/*
	var vid = [];
	for (let i=0; i<recordedBlobList.length; i++) {
		vid.push(document.createElement('video'));
	}
	for (let i=0; i<recordedBlobList.length; i++) {
		vid[i].src = URL.createObjectURL(recordedBlobList[i]);
		vid[i].onplay = function() {
			vid[i].onplay = null;
			window.setTimeout(()=>{
				let stream = vid[i].mozCaptureStream ? vid[i].mozCaptureStream() : vid[i].captureStream();
				let audio = stream.getAudioTracks()[0];
				vid[i].pause();
// this does not work - we need to actually merge the audio tracks into one track
//				canvasStream.addTrack(audio);
			},10)
		};
	}*/
	// this is to be replaced by the track that is a mix of all audio tracks of all vid's.
	canvasStream.addTrack(cameraVideo.srcObject.getAudioTracks()[0]);
	stitching = 1;
	playbackVideo.onplay = function () {
//		playbackVideo.onplay = null;
//		window.setTimeout(()=>{
		/*
			let stream = playbackVideo.mozCaptureStream ? playbackVideo.mozCaptureStream() : playbackVideo.captureStream();
			let audio = stream.getAudioTracks()[0];
			canvasStream.addTrack(audio);
			*/
//			vid[countVideoChunk].play();
			if (countVideoChunk == 0) mediaRecorder.start();
//		},20);
	}
	/*
	for (let i=0; i<recordedBlobList.length; i++) {
		vid[i].play();
	}
	*/
	playbackVideo.muted = false;
	window.setTimeout(()=>{playbackVideo.play();},200);
}

function saveVideo() {
	for (let i=0; i<recordedBlobList.length; i++) {
		if (playbackVideo.src) URL.revokeObjectURL(playbackVideo.src);
		playbackVideo.src = URL.createObjectURL(recordedBlobList[i]);
		buttonDownload.href = playbackVideo.src;
		buttonDownload.download = "video"+i.toString()+".webm";
		buttonDownload.click();
	}
	if (playbackVideo.src) URL.revokeObjectURL(playbackVideo.src);
	playbackVideo.src = URL.createObjectURL(recordedBlobList[0]);
	countVideoChunk = 0;
}

function stopEventRec(event) {
	if (discarded) {
		recordedChunks.length = lastChunkLength;
		if (recordedChunks.length>0) recordedBlobList.push(new Blob(recordedChunks, {type: "video/webm"}));
	} else {
		recordedBlobList.push(new Blob(recordedChunks, {type: "video/webm"}));
		playbackRatio = mainRatio;
		playbackVideo.src = URL.createObjectURL(recordedBlobList[0]);
		countVideoChunk=0;
		playbackVideo.onended = function() {
			var source = playbackVideo.src;
			countVideoChunk++;
			if (countVideoChunk < recordedBlobList.length) {
				playbackVideo.src = URL.createObjectURL(recordedBlobList[countVideoChunk]);
				URL.revokeObjectURL(source);
				playbackVideo.play();
			} else {
				if (stitching) {
					mediaRecorder.stop();
					buttonStitch.style.backgroundColor = "#DDD";
					stitching = 0;
				} else {
					playbackVideo.src = URL.createObjectURL(recordedBlobList[0]);
					URL.revokeObjectURL(source);
					countVideoChunk = 0;
				}
			}
		};
	}
}
function dataEventRec(event) {
	recordedChunks.push(event.data);
	if (paused && !discarded) {
		lastChunkLength = newChunkLength;
		newChunkLength = recordedChunks.length;
	}
}
function setRecorder() {
//	var canvasStream = new MediaStream(canvas.captureStream(framePerSecond).getTracks().concat(cameraVideo.srcObject.getAudioTracks()));
//	var canvasStream = new MediaStream(canvas.captureStream(framePerSecond));
//	canvasStream.addTrack(cameraVideo.srcObject.getAudioTracks()[0]);
	var canvasStream = new MediaStream([canvas.captureStream(framePerSecond).getTracks()[0],cameraVideo.srcObject.getAudioTracks()[0]]);
	var options = { mimeType: "video/webm" };
//	var options = { mimeType: "video/mp4" };
	recordedBlobList = [];
	mediaRecorder = new MediaRecorder(canvasStream,options);
	mediaRecorder.ondataavailable = dataEventRec;
	mediaRecorder.onstop = stopEventRec;
	mediaRecorder.onstart = event => {
		paused = 0;
		discarded = false;
		recordedChunks = [];
		newChunkLength = 0;
		lastChunkLength = 0;
	}
	mediaRecorder.start();
	var lightIntensity = 5;
	var lightChange = 1;
	lightInterval = window.setInterval(function() {
		lightIntensity+=lightChange;
		if (lightIntensity >= 15) lightChange = -1;
		if (lightIntensity <= 5) lightChange = 1;
		light.style.backgroundColor = "#" + lightIntensity.toString(16) + "00";
	},50);
}

function continueStartSequence() {
	if (checkboxTitle.checked) {
		playingTitle = 1;
		window.setTimeout(()=>{fadingDown = 1;},2000);
	}
}

function startRecord() {
	if (checkboxIntro.checked) {
		introVideo.play();
		playingIntro = 1;
		if (!fixedRatioMode) {
			mainRatio = introVideo.videoWidth/introVideo.videoHeight;
			sizeAll();
		}
		introVideo.addEventListener('ended',function() {
			playingIntro=0;
			if (!fixedRatioMode) setState();
			continueStartSequence();
		});
	} else continueStartSequence();
	window.setTimeout(setRecorder,100);
}

function stopRecorder() {
	mediaRecorder.requestData();
	mediaRecorder.stop();
	clearInterval(lightInterval);
	light.style.backgroundColor = "#000";
}

function continueStopSequence() {
	stopRecorder();
	buttonRecord.value = "rec";
	recording = 0;
	for (let i=0; i++; i<numberStopImages) stopImages[i]=null;
	numberStopImages = 0;
	if (!fixedRatioMode) setState();
}

function stopRecord() {
	if (playingOutro) return;
	if (checkboxOutro.checked) {
		buttonRecord.value = "...";
		outroVideo.play();
		playingOutro = 1;
		if (!fixedRatioMode) {
			mainRatio = outroVideo.videoWidth/outroVideo.videoHeight;
			sizeAll();
		}
		outroVideo.addEventListener('ended',function() {
			continueStopSequence();
			playingOutro=0;
		});
	} else continueStopSequence();
	if (playingIntro) {
		playingIntro = 0;
		introVideo.pause();
		introVideo.currentTime=0;
	}
	if (playingTitle) playingTitle=0;
}

var discarded=false;
function pauseRecord() {
	discarded = false;
	mediaRecorder.requestData();
	mediaRecorder.pause();
	stopImages[numberStopImages] = new Image();
	stopImages[numberStopImages].src = imageCanvas.toDataURL("image/png");
	numberStopImages = numberStopImages+1;

// in the end not used as pause is disabled during intro and outro
	if (playingIntro) {
		introVideo.pause();
	}
	if (playingOutro) {
		outroVideo.pause();
	}
}

function restartRecord() {
// in the end not used as pause is disabled during intro and outro
	if (playingIntro) {
		introVideo.play();
	}
	if (playingOutro) {
		outroVideo.play();
	}

	if (!discarded) mediaRecorder.resume();
	else mediaRecorder.start();
}

function discardLastSequence() {
	discarded = true;
	stopImages[numberStopImages-1]=null;
	numberStopImages --;
	mediaRecorder.stop();
}


// done at the start
function starting() {
	if (navigator.mediaDevices.getUserMedia) {
 	 	navigator.mediaDevices.getUserMedia({ audio: true, video: true })
    	.then(function (stream) {
    	  	cameraVideo.srcObject = stream;
    	  	cameraVideo.onloadedmetadata = (ev) => {
    	  		[cameraVideo.style.width, cameraVideo.style.height] = resizecss(cameraVideo.videoWidth/cameraVideo.videoHeight,controlsVideoMaxWidth,controlsVideoMaxHeight);
				changeState(1);
    	  	};
    	})
    	.catch(function (error) {
    		cameraVideo.srcObject = null;
    	  	changeState();
    	});
	} else {
		cameraVideo.srcObject = null;
    	changeState();
    }
    componentVideo.clipUp=0;
    componentVideo.clipDown=0;
    componentVideo.clipLeft=0;
    componentVideo.clipRight=0;
    cameraVideo.clipUp=0;
    cameraVideo.clipDown=0;
    cameraVideo.clipLeft=0;
    cameraVideo.clipRight=0;
    playbackVideo.src = null;
	context = canvas.getContext('2d');
	imageContext = imageCanvas.getContext('2d');
	var h,w;
	recordInterval = window.setInterval(function() {
		// note: h * h * ratio = pixels
		if (!fixedRatioMode) {
			h = Math.sqrt(pixels / mainRatio);
			w = h * mainRatio;
			canvas.width = w;
			canvas.height = h;
			imageCanvas.width = w;
			imageCanvas.height = h;
		} else {
			var h = Math.sqrt(pixels / fixedRatio);
			var w = h * fixedRatio;
		}
		if (!paused && !stitching) context.clearRect(0, 0, canvas.width, canvas.height);
		if (comingBack && numberStopImages>0){
			context.globalAlpha = 1;
			context.drawImage(stopImages[numberStopImages-1],0,0);
		}
		if (stitching) {
			context.globalAlpha = 1;
			context.drawImage(playbackVideo,0,0,w,h);
		} else if (playingOutro) {
/*			let sw=outroVideo.videoWidth;
			let sh=outroVideo.videoHeight;
			let [newsw,newsh] = resize(sw/sh,w,h);
			let sy = (h-newsh)/2;
			let sx = (w-newsw)/2;
			context.drawImage(outroVideo,sx,sy,newsw,newsh);*/
			context.drawImage(outroVideo,0,0,w,h);
		}
		else if (playingIntro) {
/*
			let sw=introVideo.videoWidth;
			let sh=introVideo.videoHeight;
			let [newsw,newsh] = resize(sw/sh,w,h);
			let sy = (h-newsh)/2;
			let sx = (w-newsw)/2;
			context.drawImage(introVideo,sx,sy,newsw,newsh);*/
			context.drawImage(introVideo,0,0,w,h);
		} else {
			if (playingTitle) {
				if (fadingDown || fadingUp) {
					context.globalAlpha = alpha;
				}
				context.fillStyle = "white";
				context.fill();
				context.font = '48px sans-serif';
				context.textAlign = "center"; 
				let size = theTitleLines.length;
				theTitleLines.forEach((s,i)=>context.fillText(s,w/2,(h-size*48)/2+48*i));
			} else if (!paused) {
				if ((fadingDown || fadingUp) && changeMain) {
					context.globalAlpha = alpha;
				}
				let [sx,sy] = [(1-mainWidthFactor)*w/2, (1-mainHeightFactor)*h/2];
				if (mainVideo.srcObject) context.drawImage(mainVideo,mainVideo.clipLeft,mainVideo.clipUp,mainVideo.clipWidth,mainVideo.clipHeight,sx,sy,mainWidthFactor*w,mainHeightFactor*h);
				if ((fadingDown || fadingUp) && !changeMain) {
					context.globalAlpha = alpha;
				}
				if (secondaryVideo.srcObject) context.drawImage(secondaryVideo,secondaryVideo.clipLeft,secondaryVideo.clipUp,secondaryVideo.clipWidth,secondaryVideo.clipHeight,(1-secondaryWidthFactor)*w-5,(1-secondaryHeightFactor)*h-5,secondaryWidthFactor*w,secondaryHeightFactor*h);
			}
			imageContext.drawImage(canvas,0,0);
			context.globalAlpha = 1;
			if (checkboxWatermark.checked) context.drawImage(watermarkImage,w-watermarkImage.width,0);
		}
		if (fadingDown) {
			alpha = alpha - 0.1*25/framePerSecond;
			if (alpha<=0) {
				fadingDown = 0;
				alpha = 0;
				setState();
				fadingUp = 1;
			}
		}
		if (fadingUp) {
			if (comingBack) alpha = alpha + 0.1*25/framePerSecond;
			else alpha = alpha + 0.1*25/framePerSecond;
			if (alpha>=1) {
				alpha = 1;
				fadingUp = 0;
				comingBack=0;
				context.globalAlpha = 1;
			}
		}
	}, 1000/framePerSecond);
}

if (document.readyState === 'loading') {  // Loading hasn't finished yet
	document.addEventListener('DOMContentLoaded', starting);
} else {  // `DOMContentLoaded` has already fired
	starting();
}

introVideo.addEventListener("loadedmetadata", function() {
	if (!fixedRatioMode) return;
	fixedRatio = introVideo.videoWidth / introVideo.videoHeight;
	sizeAll();
	var h = Math.sqrt(pixels / fixedRatio);
	var w = h * fixedRatio;
	canvas.width = w;
	canvas.height = h;
	imageCanvas.width = w;
	imageCanvas.height = h;
});

document.addEventListener('keydown', (event) => {
	if (document.activeElement === textTitle) return;
	const keyName = event.key;
	if (keyName == "1") document.getElementById('buttonConf1').click();
	if (keyName == "2") document.getElementById('buttonConf2').click();
	if (keyName == "3") document.getElementById('buttonConf3').click();
	if (keyName == "4") document.getElementById('buttonConf4').click();
	if (keyName == " ") document.getElementById('buttonRecord').click();
	if (keyName == "0") document.getElementById('buttonPause').click();
	if (keyName == "-") document.getElementById('buttonPlayback').click();
});

window.addEventListener("resize",sizeAll);

document.getElementById('buttonConf1').addEventListener('click', () => changeState(1));

document.getElementById('buttonConf2').addEventListener('click', () => changeState(2));

document.getElementById('buttonConf3').addEventListener('click', () => changeState(3));

document.getElementById('buttonConf4').addEventListener('click', () => changeState(4));

buttonRecord.addEventListener('click', function() {
	if (!mainVideo.srcObject) return;
	if (fadingDown || fadingUp || playingback || paused || stitching) return;
	if (recording) {
		stopRecord();
		buttonPlayback.value = "playback";
// not used now : stop disabled during pause
		if (paused) {
			paused=0;
			buttonPause.style.backgroundColor = "#DDD";
		}
	} else {
		startRecord();
		buttonRecord.value = "stop";
		buttonPlayback.value = "discard";
		recording = 1;
	}
});

buttonPlayback.addEventListener('click', function() {
	if (paused && numberStopImages > 1 && !discarded) {
		discardLastSequence();
	}
	if (fadingDown || fadingUp || recording || !playbackVideo.src || stitching) return;
	if (playingback) {
		playbackVideo.style.visibility = "hidden";
//		canvas.style.visibility = "visible";
		buttonPlayback.style.backgroundColor = "#DDD";
		playingback = 0;
		sizeAll();
	} else {
		playbackVideo.style.visibility = "visible";
//		canvas.style.visibility = "hidden";
		buttonPlayback.style.backgroundColor = "#BBF";
		playingback = 1;
		playbackVideo.play();
		sizeAll();
	}
});

buttonPause.addEventListener('click', function() {
	if (recording && !(fadingDown || fadingUp || playingTitle || playingIntro || playingOutro)) {
		if (!paused) {
			pauseRecord();
			paused=1;
			buttonPause.style.backgroundColor = "#BBF";
			if (numberStopImages>1) buttonPlayback.value = "discard";
		}
		else {
			restartRecord();
			paused=0;
			comingBack=1;
			changeMain=1;
			alpha=0;
			fadingUp=1;
			buttonPause.style.backgroundColor = "#DDD";
		}
	}	
});

buttonStitch.addEventListener('click', function() {
	if (fadingDown || fadingUp || recording || playingback || recordedBlobList.length<2) return;
	if (stitching) {
		stitching = 0;
		buttonStitch.style.backgroundColor = "#DDD";
	}
	else {
		buttonStitch.style.backgroundColor = "#BBF";
		stitchVideo();
	}
});

buttonSave.addEventListener('click', function() {
	if (!stitching) saveVideo();
});

buttonTitle.addEventListener('click', function() {
	if (textTitle.style.visibility==="visible") {
		textTitle.style.visibility="hidden";
		buttonTitle.value="set";
		theTitleLines = textTitle.value.split('\n');
	} else {
		textTitle.style.visibility="visible";
		buttonTitle.value="ok";
		checkboxTitle.checked= true;
	}
});

textTitle.addEventListener("focusout", function() {
	textTitle.style.visibility="hidden";
	buttonTitle.value="set";
	theTitleLines = textTitle.value.split('\n');
});

buttonChooseComponent.addEventListener('click', function() {
	if (playingTitle || playingIntro || playingOutro || fadingDown || fadingUp || playingback) return;
	if (navigator.mediaDevices.getDisplayMedia) {
 	 	navigator.mediaDevices.getDisplayMedia({ video: true })
    	.then(function (stream) {
    	  	componentVideo.srcObject = stream;
    	  	componentVideo.onloadedmetadata = (ev) => {
    	  		[componentVideo.style.width, componentVideo.style.height] = resizecss(componentVideo.videoWidth/componentVideo.videoHeight,controlsVideoMaxWidth,controlsVideoMaxHeight);
    	  		changeState();
    	  		buttonChooseComponent.style.visibility="hidden";
    	  		componentVideo.style.visibility="visible";
    	  	};
    	})
    	.catch(function (error) {
    	});
	}
});

comp.addEventListener('mouseover', function() {
	if (playingback) return;
	if (componentVideo.srcObject) buttonStopComponent.style.visibility = "visible";
});

comp.addEventListener('mouseout', function() {
	if (playingback) return;
	buttonStopComponent.style.visibility = "hidden";
});

buttonStopComponent.addEventListener('click', stopCapture);
function stopCapture(evt) {
	if (playingTitle || playingIntro || playingOutro || fadingDown || fadingUp || playingback) return;
	componentVideo.style.visibility = "hidden";
    buttonChooseComponent.style.visibility="visible";
	buttonStopComponent.style.visibility = "hidden";
	let tracks = componentVideo.srcObject.getTracks();
	tracks.forEach(track => track.stop());
	componentVideo.srcObject = null;
	componentVideo.style.width = tocss(controlsVideoMaxWidth);
	componentVideo.style.height = tocss(controlsVideoMaxHeight);
	changeState();
}

</script>